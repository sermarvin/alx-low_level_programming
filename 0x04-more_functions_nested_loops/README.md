More functions and more neseted loops.
